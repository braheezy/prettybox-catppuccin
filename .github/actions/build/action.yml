name: Packer Build

runs:
  using: "composite"
  steps:
    - name: Install build deps
      run: sudo sh ./configure
      shell: bash

    # As recommended by the Packer Github Action, run a bunch of pre-checks
    - name: Fix any backwards incompatibilities in template
      uses: hashicorp/packer-github-actions@master
      with:
        command: fix

    - name: Validate template syntax
      uses: hashicorp/packer-github-actions@master
      with:
        command: validate
        arguments: --syntax-only
        target: template.pkr.hcl

    - name: Build artifacts
      uses: hashicorp/packer-github-actions@master
      with:
        command: build Virtualbox
        arguments: "-color=false -on-error=abort -only=vagrant.vbox"
        target: template.pkr.hcl
      env:
        PACKER_LOG: 1
